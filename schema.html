

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Reference Schema &mdash; Big Fat Happy Data v0.0.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Big Fat Happy Data v0.0.0 documentation" href="index.html" />
    <link rel="next" title="Frequently Asked Questions" href="faq.html" />
    <link rel="prev" title="Introduction" href="intro.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="faq.html" title="Frequently Asked Questions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Big Fat Happy Data v0.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="reference-schema">
<h1>Reference Schema<a class="headerlink" href="#reference-schema" title="Permalink to this headline">¶</a></h1>
<p>Using the reference specification from the previous topic lets go ahead and
define a very simple schema in MySQL using Django that doesn&#8217;t rely on multiple
accounts per collection or multiple collections per criteria.</p>
<p>One of the goals for what we will call &#8216;Schema1&#8217; is to be able able to pull up all major model
types by the primary key, of course, as well as order some of them based on an integer field
that helps define the order.</p>
<div class="section" id="simple-normalized-row-schema-mysql">
<h2>Simple Normalized Row Schema (MySQL)<a class="headerlink" href="#simple-normalized-row-schema-mysql" title="Permalink to this headline">¶</a></h2>
<p>Before we add the reference specification into Django we have the following base
tables:</p>
<div class="highlight-mysql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="kp">tables</span><span class="p">;</span>
<span class="o">+----------------------------+</span>
<span class="o">|</span> <span class="n">Tables_in_schema1</span>          <span class="o">|</span>
<span class="o">+----------------------------+</span>
<span class="o">|</span> <span class="n">auth_group</span>                 <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_group_permissions</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_message</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_permission</span>            <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_user</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_user_groups</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">auth_user_user_permissions</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">django_content_type</span>        <span class="o">|</span>
<span class="o">|</span> <span class="n">django_session</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">django_site</span>                <span class="o">|</span>
<span class="o">+----------------------------+</span>
<span class="mi">10</span> <span class="n">rows</span> <span class="k">in</span> <span class="kt">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>A lot of this information is used as references when joining tables together.
Much of it could stay in the database clients memory if the data that depended
on it found a way to reference it less.  It seems, however and probably
rightfully so, that by offloading reference data to a fast SQL server and using
it effectively through joins is a great idea that helps global changes happen
quickly and allows for extra filtering before rows are returned.</p>
<p>Now to add the very simple specification into Django and create a database schema.  The first
block is the Django model information and the second is simply a list of the table names
followed by a block defining the schema.</p>
<p><strong>The ORM code</strong></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;collection_to_account&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Criteria</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;criteria_to_account&#39;</span><span class="p">)</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;criteria_to_collection&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UserProfile</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AccountUserProfile</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;user_profile_to_account&#39;</span><span class="p">)</span>
    <span class="n">morestuff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CollectionUserProfile</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;collection_user_profile_to_account&#39;</span><span class="p">)</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;collection_user_profile_to_collection&#39;</span><span class="p">)</span>
    <span class="n">morestuff</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><strong>The tables</strong></p>
<div class="highlight-mysql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="kp">tables</span> <span class="k">where</span> <span class="n">Tables_in_schema1</span> <span class="k">like</span> <span class="s1">&#39;schema1%&#39;</span><span class="p">;</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">Tables_in_schema1</span>             <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">schema1_account</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">schema1_accountuserprofile</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">schema1_collection</span>            <span class="o">|</span>
<span class="o">|</span> <span class="n">schema1_collectionuserprofile</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">schema1_criteria</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">schema1_userprofile</span>           <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="mi">6</span> <span class="n">rows</span> <span class="k">in</span> <span class="kt">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><strong>The schema</strong></p>
<div class="highlight-mysql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_account`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`name`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_collection`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`name`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`account_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`order`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_collection`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`account_id_refs_id_ab621b21`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_criteria`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`name`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`account_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`collection_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`order`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`stuff`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_criteria`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`account_id_refs_id_e50b6b8e`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_criteria`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`collection_id_refs_id_7ca4af94`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`collection_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_collection`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_userprofile`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`user_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`stuff`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_userprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`user_id_refs_id_65460c04`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`auth_user`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_accountuserprofile`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`user_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`account_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`morestuff`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_accountuserprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`user_id_refs_id_914095d0`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_accountuserprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`account_id_refs_id_914095d0`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">integer</span> <span class="kp">AUTO_INCREMENT</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="ss">`user_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`account_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`collection_id`</span> <span class="kt">integer</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`morestuff`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span>
<span class="p">)</span>
<span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`user_id_refs_id_8f7b0662`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`account_id_refs_id_8f7b0662`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_account`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="ss">`collection_id_refs_id_ea4e2924`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`collection_id`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="ss">`schema1_collection`</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_collection_6f2fe10e`</span> <span class="k">ON</span> <span class="ss">`schema1_collection`</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_criteria_6f2fe10e`</span> <span class="k">ON</span> <span class="ss">`schema1_criteria`</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_criteria_26d6361e`</span> <span class="k">ON</span> <span class="ss">`schema1_criteria`</span> <span class="p">(</span><span class="ss">`collection_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_userprofile_fbfc09f1`</span> <span class="k">ON</span> <span class="ss">`schema1_userprofile`</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_accountuserprofile_fbfc09f1`</span> <span class="k">ON</span> <span class="ss">`schema1_accountuserprofile`</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_accountuserprofile_6f2fe10e`</span> <span class="k">ON</span> <span class="ss">`schema1_accountuserprofile`</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_collectionuserprofile_fbfc09f1`</span> <span class="k">ON</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="p">(</span><span class="ss">`user_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_collectionuserprofile_6f2fe10e`</span> <span class="k">ON</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="p">(</span><span class="ss">`account_id`</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="ss">`schema1_collectionuserprofile_26d6361e`</span> <span class="k">ON</span> <span class="ss">`schema1_collectionuserprofile`</span> <span class="p">(</span><span class="ss">`collection_id`</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<p>That&#8217;s pretty clean and simple.  It&#8217;s usable for smaller databases that don&#8217;t offer the
flexability.  We have indexes in place that will help us out quite a bit as well.  Lets take a
look at some queries however.  Say lets find all of the collection user profiles that exist for
account 1 and relate to user 1.  The first block of code will be done through the python shell
and the second is as seen from the MySQL general log.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">models</span><span class="o">.</span><span class="n">CollectionUserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-mysql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`user_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`account_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`collection_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`morestuff`</span>
   <span class="k">FROM</span>
      <span class="ss">`schema1_collectionuserprofile`</span>
   <span class="k">WHERE</span>
      <span class="p">(</span>
         <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`account_id`</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">AND</span>
         <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`user_id`</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Everything appears in order.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">models</span><span class="o">.</span><span class="n">CollectionUserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;collection_order&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-mysql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`user_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`account_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`collection_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`morestuff`</span><span class="p">,</span>
      <span class="n">T3</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="n">T3</span><span class="p">.</span><span class="ss">`name`</span><span class="p">,</span>
      <span class="ss">`schema1_account`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="ss">`schema1_account`</span><span class="p">.</span><span class="ss">`name`</span><span class="p">,</span>
      <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`name`</span><span class="p">,</span>
      <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`account_id`</span><span class="p">,</span>
      <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`order`</span><span class="p">,</span>
      <span class="n">T5</span><span class="p">.</span><span class="ss">`id`</span><span class="p">,</span>
      <span class="n">T5</span><span class="p">.</span><span class="ss">`name`</span>
   <span class="k">FROM</span>
      <span class="ss">`schema1_collectionuserprofile`</span>
   <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`schema1_account`</span> <span class="k">ON</span> <span class="p">(</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`account_id`</span> <span class="o">=</span> <span class="ss">`schema1_account`</span><span class="p">.</span><span class="ss">`id`</span>
   <span class="p">)</span>
   <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`schema1_account`</span> <span class="n">T3</span> <span class="k">ON</span> <span class="p">(</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`user_id`</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.</span><span class="ss">`id`</span>
   <span class="p">)</span>
   <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`schema1_collection`</span> <span class="k">ON</span> <span class="p">(</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`collection_id`</span> <span class="o">=</span> <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`id`</span>
   <span class="p">)</span>
   <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">`schema1_account`</span> <span class="n">T5</span> <span class="k">ON</span> <span class="p">(</span>
      <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`account_id`</span> <span class="o">=</span> <span class="n">T5</span><span class="p">.</span><span class="ss">`id`</span>
   <span class="p">)</span>
   <span class="k">WHERE</span> <span class="p">(</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`account_id`</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="k">AND</span>
      <span class="ss">`schema1_collectionuserprofile`</span><span class="p">.</span><span class="ss">`user_id`</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="p">)</span>
   <span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">`schema1_collection`</span><span class="p">.</span><span class="ss">`order`</span> <span class="k">ASC</span>
</pre></div>
</td></tr></table></div>
<p>Django is currently doing it&#8217;s best to make sure MySQL is using indexes wherever possible per
join.  MySQL is now collecting the information like a champ, sifting it, and then streaming it
back to the client application where Django can process the output.</p>
<p>Easy peasy lemon squeezy.</p>
</div>
<div class="section" id="the-proposition-simple-document-based-schema-mongodb">
<h2>The Proposition: Simple Document Based Schema (MongoDB)<a class="headerlink" href="#the-proposition-simple-document-based-schema-mongodb" title="Permalink to this headline">¶</a></h2>
<p>Since MongoDB is schemaless the following includes some sample data from a well known company we
all know and love.</p>
<div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* For readability only lets pre-define some ObjectIDs */</span>
<span class="nx">yoyodyne_account</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors_active</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors_archived</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_personel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors_criteria_model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors_criteria_speed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_propulsors_criteria_flux</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_personel_criteria_fullname</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">yoyodyne_collection_personel_criteria_loyalty</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>
<span class="nx">john_user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">();</span>

<span class="cm">/* ACCOUNT(S) */</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span> <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;collections._id&#39;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_account</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="s1">&#39;Yoyodyne Propulsion Systems&#39;</span><span class="p">,</span>
    <span class="s1">&#39;shortname&#39;</span> <span class="o">:</span> <span class="s1">&#39;yoyodyne&#39;</span><span class="p">,</span>
    <span class="s1">&#39;collection_shortnames&#39;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;propulsors&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span>
        <span class="s1">&#39;propulsors_active&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_active</span><span class="p">,</span>
        <span class="s1">&#39;propulsors_archived&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_archived</span><span class="p">,</span>
        <span class="s1">&#39;personel&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_personel</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;collections&#39;</span> <span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="s1">&#39;Propulsors Division&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span> <span class="o">:</span> <span class="s1">&#39;propulsors&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">:</span> <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_active</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="s1">&#39;Active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span> <span class="o">:</span> <span class="s1">&#39;propulsors_active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">:</span> <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span> <span class="nx">yoyodyne_collection_propulsors_active</span><span class="p">],</span>
            <span class="s1">&#39;criteria_shortnames&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;model&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_model</span><span class="p">,</span>
                <span class="s1">&#39;speed&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_speed</span><span class="p">,</span>
                <span class="s1">&#39;flux&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_flux</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;criteria&#39;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_model</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span> <span class="o">:</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_speed</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Speed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;speed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span> <span class="o">:</span> <span class="s1">&#39;Speed&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_flux</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span> <span class="o">:</span> <span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_archived</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="s1">&#39;Archived&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span> <span class="o">:</span> <span class="s1">&#39;propulsors_archived&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">:</span> <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span> <span class="nx">yoyodyne_collection_propulsors_archived</span><span class="p">],</span>
            <span class="s1">&#39;criteria_shortnames&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;model&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_model</span><span class="p">,</span>
                <span class="s1">&#39;speed&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_speed</span><span class="p">,</span>
                <span class="s1">&#39;flux&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_flux</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;criteria&#39;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_model</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_speed</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Speed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;speed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_propulsors_criteria_flux</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_personel</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span> <span class="o">:</span> <span class="s1">&#39;Personel Files&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span> <span class="o">:</span> <span class="s1">&#39;personel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">:</span> <span class="p">[</span><span class="nx">yoyodyne_collection_personel</span><span class="p">],</span>
            <span class="s1">&#39;criteria_shortnames&#39;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s1">&#39;fullname&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_personel_criteria_fullname</span><span class="p">,</span>
                <span class="s1">&#39;loyalty&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_collection_personel_criteria_loyalty</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;criteria&#39;</span> <span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_personel_criteria_fullname</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Full Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;fullname&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="nx">yoyodyne_collection_personel_criteria_loyalty</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span> <span class="o">:</span> <span class="s1">&#39;Loyalty&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;shortname&#39;</span><span class="o">:</span> <span class="s1">&#39;loyalty&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s1">&#39;paths&#39;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span> <span class="nx">yoyodyne_collection_propulsors_active</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">yoyodyne_collection_propulsors</span><span class="p">,</span> <span class="nx">yoyodyne_collection_propulsors_archived</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">yoyodyne_collection_personel</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">});</span>

<span class="cm">/* USER(S) */</span>

<span class="cm">/* Keep this information in memory.  indexOnly is fun. */</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span> <span class="s1">&#39;username&#39;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
    <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="nx">john_user</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
    <span class="s1">&#39;firstname&#39;</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lastname&#39;</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="o">:</span> <span class="s1">&#39;$2a$12$xcNqZUe7xO3oOrCnngzKROta1fBCXJovX9ih.YouaTUhOXYyppBYi&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nickname&#39;</span><span class="o">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accounts&#39;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="nx">yoyodyne_account</span><span class="p">,</span>
            <span class="s1">&#39;active&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>So we can see that the account has several collections, one appears to be a holder collection
for two others.  Their &#8216;order&#8217; as displayed is pregenerated as a list of lists called &#8216;paths&#8217; in
the base of the account document and won&#8217;t require any crazy iteration or recursion to generate
later on.  If you want to move the archived propulsors above the active propulsors you know who
the parent is immediately and you can quickly reorganize the list.</p>
<p>Each collection also has a &#8216;path&#8217; field which is used for display purposes.  When reviewing just
one collection it may be important to show the full path to that collection in the summary
information and traversing the main &#8216;paths&#8217; list could end up taking up more CPU however
unlikely.</p>
<p>We also have a multi-key (and multi-multi-key) index where the account id is first and the
collection id is second.  This is an important difference from how most RDBMS solutions work.  A
new index will be created for each collection per index since document based database solutions
support arrays and hashes.  MongoDB specifically allows secondary indexes of array information
which is useful for storing search terms, finding sub-documents like our collections, and all
sorts of crazy things.</p>
<p>The users also have a secondary index that stores their username, then their password, then
their id in the database.  Initially this helps when trying to find a user by username.  If we
simply defined a single key index on the &#8216;username&#8217; field we would have two options on how data
is returned to us.</p>
<p>First we could return the entire document which has to be parsed into a dictionary style element
by the interpreter running the app.  If your users have half meg profiles (say there was an icon
or 20 stored in it) then you would be parsing that every time that username was looked up.
Since users are also seen as the keys to the city those username requests could happen very
often if a password attack is being done against your app.  That database and parsing time can add up quickly.</p>
<p>The second option is we could return just the index information by telling MongoDB that instead
of returning the document, just return the &#8216;username&#8217; and we will test to see if it exists based
on if anything returns.  This is useful for a first-phase of identifying a valid username before
attempting to use any CPU intensive cryptography or pull the entire user document.</p>
<p>However, the index that is specified for the users above includes a password and the object ID
at the very end.  Our index is a bit larger now but it contains some very useful information.
First off you can still specify just a username in the query and still use this multi-key index
to speed up lookups without needing an index just for one field.  Now if we tell MongoDB to pull
just the index information we also get the password hash and the ID of the document which we can
use directly in future pulls of the user information from a much smaller index.</p>
<p>Just because you are pulling the password information doesn&#8217;t mean you need to use it, same with
the ID information.  Any fields after the key you actually used to search with is ephemeral and
can be ignored if you don&#8217;t need to use it.  The cost of pulling that information is typically
much smaller than the cost of pulling the full document later after you test for it.  In a web
application where password attacks happen quite a bit it is a good idea to filter out those
usernames that don&#8217;t exist using a very fast index then if they do exist check the password
using another very fast database and finally pull the entire user profile into your users
session by throwing it into a memory cache like Redis or Memcached.  You may also find that
pulling the document into a memory cache and storign keys for the username and password as well
as possibly the document itself is a very fast solution that doesn&#8217;t require a multi-key index.</p>
<p>The password above was stored using BCrypt.  BCrypt is a one way hash that is <em>HIGHLY</em>
recommended as very safe alternative to other hashes and of course storing passwords in plain
text.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Reference Schema</a><ul>
<li><a class="reference internal" href="#simple-normalized-row-schema-mysql">Simple Normalized Row Schema (MySQL)</a></li>
<li><a class="reference internal" href="#the-proposition-simple-document-based-schema-mongodb">The Proposition: Simple Document Based Schema (MongoDB)</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="faq.html"
                        title="next chapter">Frequently Asked Questions</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/schema.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="faq.html" title="Frequently Asked Questions"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             >previous</a> |</li>
        <li><a href="index.html">Big Fat Happy Data v0.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Shane R. Spencer.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>